<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Susun Kata Bahasa Jepang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5", // Indigo
              secondary: "#10B981", // Emerald
              accent: "#FBBF24", // Amber
              background: "#F9FAFB", // Gray-50
              card: "#FFFFFF",
              llm: "#4285F4", // Google Blue
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      .word-button {
        transition: all 0.15s ease-in-out;
        cursor: pointer;
        user-select: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.06);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem; /* Adjust padding for better look with two lines */
        line-height: 1.2; /* Adjust line height */
      }
      .word-button:hover:not(.used) {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -4px rgba(0, 0, 0, 0.05);
      }
      .word-button .japanese-text {
        font-size: 0.8em; /* Smaller font for Japanese text */
        margin-bottom: 0.2rem; /* Space between Japanese and Romaji */
      }
      .word-button .romaji-text {
        font-size: 1em;
        text-transform: uppercase;
      }
      .used {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #e5e7eb; /* Gray-200 */
      }
      .llm-loading {
        position: relative;
      }
      .llm-loading::after {
        content: "";
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #ffffff;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 8px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-background min-h-screen p-4 sm:p-8 font-sans flex items-center justify-center"
  >
    <div id="app" class="w-full max-w-4xl">
      <!-- Header -->
      <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-primary mb-2">
          チャレンジ Menyusun Kata
        </h1>
        <p class="text-lg text-gray-600">
          Susun kalimat Bahasa Jepang dengan benar!
        </p>
        <p class="text-lg text-gray-600">Dibuat oleh Deden Hidayat!</p>
      </header>

      <!-- Game Card -->
      <div
        id="game-card"
        class="bg-card p-6 sm:p-8 rounded-xl shadow-2xl border-b-4 border-primary/50"
      >
        <!-- Prompt Area -->
        <div
          class="mb-6 bg-primary/10 border-l-4 border-primary p-4 rounded-md"
        >
          <p class="text-sm font-semibold text-primary mb-1">Tugas Anda:</p>
          <h2 id="task-prompt" class="text-xl font-bold text-gray-800">
            Memuat tantangan...
          </h2>
        </div>

        <!-- Current Input Area -->
        <div
          class="mb-8 p-4 min-h-[80px] border-2 border-dashed border-gray-300 rounded-lg bg-white shadow-inner flex flex-wrap gap-2 items-center"
          id="input-area"
        >
          <span class="text-gray-400 italic"
            >Klik kata-kata di bawah untuk menyusun kalimat...</span
          >
        </div>

        <!-- Word Bank Area (Scrambled Words) -->
        <div class="mb-8">
          <p class="text-sm font-semibold text-gray-600 mb-2">Pilihan Kata:</p>
          <div id="word-bank" class="flex flex-wrap gap-2">
            <!-- Buttons will be inserted here -->
          </div>
        </div>

        <!-- Controls and Messages -->
        <div
          class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0"
        >
          <div class="flex space-x-2 w-full sm:w-auto">
            <button
              id="reset-button"
              onclick="resetInput()"
              class="w-1/2 sm:w-auto px-4 py-2 bg-accent text-white font-bold rounded-full hover:bg-accent/80 transition-colors"
            >
              <span id="reset-text">Ulangi Susunan</span>
            </button>
            <!-- ✨ LLM Hint Button --><button
              id="hint-button"
              onclick="getHint()"
              class="w-1/2 sm:w-auto px-4 py-2 bg-llm text-white font-bold rounded-full shadow-md hover:bg-llm/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ✨ Minta Petunjuk
            </button>
          </div>

          <div id="message-area" class="text-center font-semibold h-6">
            <!-- Feedback messages will appear here -->
          </div>
          <button
            id="next-button"
            onclick="nextChallenge()"
            class="w-full sm:w-auto px-6 py-3 bg-secondary text-white font-bold rounded-full shadow-lg hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Lanjut Tantangan (0/8)
          </button>
        </div>

        <!-- ✨ LLM Output Area -->
        <div id="llm-output-area" class="mt-8">
          <!-- Explanation button appears here on success --><button
            id="explanation-button"
            onclick="getExplanation()"
            class="hidden w-full px-6 py-3 bg-llm text-white font-bold rounded-xl shadow-lg hover:bg-llm/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            ✨ Jelaskan Tata Bahasa Kalimat Ini
          </button>

          <!-- LLM Response display -->
          <div
            id="llm-response"
            class="hidden mt-4 p-4 bg-llm/10 border-l-4 border-llm rounded-lg text-gray-800"
          >
            <p class="font-semibold text-llm mb-2">Tutor Gemini:</p>
            <div id="llm-content"></div>
          </div>
        </div>

        <!-- Score / Status -->
        <div id="status-area" class="mt-4 text-center text-sm text-gray-500">
          Status: <span id="current-index">1</span> dari
          <span id="total-challenges">8</span>
        </div>
      </div>

      <!-- Completion Modal -->
      <div
        id="completion-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      >
        <div
          class="bg-white p-8 rounded-xl shadow-3xl max-w-sm w-full text-center"
        >
          <h3 class="text-3xl font-extrabold text-secondary mb-4">
            Selamat! Challenge Selesai!
          </h3>
          <p class="text-gray-700 mb-6">
            Anda telah berhasil menyusun semua 8 kalimat dengan sempurna.
          </p>
          <button
            onclick="window.location.reload()"
            class="px-6 py-3 bg-primary text-white font-bold rounded-full hover:bg-primary/80 transition-colors"
          >
            Mulai Ulang Game
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- API Configuration and Utility Functions ---

      const API_URL =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
      const API_KEY = ""; // Canvas environment will provide the key at runtime

      /**
       * Fetches response from Gemini API with exponential backoff.
       * @param {string} userQuery - The user's query/prompt.
       * @param {string} systemPrompt - The instruction for the model's persona.
       * @param {number} maxRetries - Maximum number of retries.
       * @param {number} delay - Initial delay in milliseconds.
       * @returns {Promise<string|null>} The generated text or null on failure.
       */
      async function fetchLlmResponse(
        userQuery,
        systemPrompt,
        maxRetries = 3,
        delay = 1000
      ) {
        const payload = {
          contents: [{ parts: [{ text: userQuery }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        for (let i = 0; i < maxRetries; i++) {
          try {
            const response = await fetch(API_URL + API_KEY, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              if (response.status === 429 && i < maxRetries - 1) {
                // Too many requests, retry with backoff
                await new Promise((resolve) =>
                  setTimeout(resolve, delay * 2 ** i)
                );
                continue;
              }
              console.error(
                `API Error: ${response.status} ${response.statusText}`
              );
              return `Error: Gagal mendapatkan respons dari server (${response.status}).`;
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
              return text;
            } else {
              console.error("API Response structure invalid:", result);
              return "Error: Struktur respons AI tidak valid.";
            }
          } catch (error) {
            console.error("Fetch failed:", error);
            if (i < maxRetries - 1) {
              await new Promise((resolve) =>
                setTimeout(resolve, delay * 2 ** i)
              );
              continue;
            }
            return "Error: Koneksi ke server gagal. Cek koneksi internet Anda.";
          }
        }
        return "Error: Gagal mendapatkan respons setelah beberapa kali percobaan.";
      }

      /**
       * Converts Romaji to Japanese script (Hiragana/Katakana/Kanji).
       * This function uses a simple lookup for common words.
       * @param {string} romaji - The Romaji word.
       * @returns {string} The corresponding Japanese script (Kanji/Kana or just Kana).
       */
      function romajiToJapanese(romaji) {
        const map = {
          // Hanya menggunakan Kanji untuk Sensei, Gakkou, Gakusei, Seito
          watashi: "わたし",
          wa: "は",
          gakusei: "学生/がくせい", // Kanji + Hiragana
          desu: "です",
          koukousei: "こうこうせい", // Hiragana saja
          shokuinshitsu: "しょくいんしつ", // Hiragana saja
          ni: "に",
          sensei: "先生/せんせい", // Kanji + Hiragana
          ga: "が",
          imasu: "います",
          toshoshitsu: "としょしつ", // Hiragana saja
          seito: "生徒/せいと", // Kanji + Hiragana
          arimasu: "あります",
          no: "の",
          tsukue: "つくえ", // Hiragana saja
          ue: "うえ", // Hiragana saja
          hon: "ほん", // Hiragana saja
          juuichinensei: "じゅういちねんせい", // Hiragana saja
          kyoushitsu: "きょうしつ", // Hiragana saja
          tonari: "となり", // Hiragana saja
          made: "まで",
          kara: "から",
          gakkou: "学校/がっこう", // Kanji + Hiragana
          shichigatsu: "しちがつ", // Hiragana saja
          rokugatsu: "ろくがつ", // Hiragana saja
          Indonesia: "インドネシア", // Katakana
          SMAN81: "SMAN81", // Romaji/Angka
        };
        return map[romaji.toLowerCase()] || romaji; // Return Romaji if not found in map
      }

      // --- Game Data and Elements ---

      const challenges = [
        {
          jp: "watashi wa gakusei desu",
          id: "Susun kalimat: 'Saya adalah murid.' dalam bahasa Jepang!",
        },
        {
          jp: "watashi wa koukousei desu",
          id: "Susun kalimat: 'Saya adalah murid SMA.' dalam bahasa Jepang!",
        },
        {
          jp: "shokuinshitsu ni sensei ga imasu",
          id: "Susun kalimat: 'Guru ada di ruang guru.' dalam bahasa Jepang!",
        },
        {
          jp: "toshoshitsu ni seito ga imasu",
          id: "Susun kalimat: 'Murid ada di perpustakaan.' dalam bahasa Jepang!",
        },
        {
          jp: "sensei no tsukue no ue ni hon ga arimasu",
          id: "Susun kalimat: 'Buku ada di atas meja guru.' dalam bahasa Jepang!",
        },
        {
          jp: "juuichinensei no kyoushitsu wa toshoshitsu no tonari ni arimasu",
          id: "Susun kalimat: 'Kelas 11 ada di sebelah perpustakaan.' dalam bahasa Jepang!",
        },
        {
          jp: "Indonesia no gakkou wa shichigatsu kara rokugatsu made desu",
          id: "Susun kalimat: 'Sekolah di Indonesia dari Juli sampai Juni.' dalam bahasa Jepang!",
        },
        {
          jp: "watashi no gakkou wa SMAN81 desu",
          id: "Susun kalimat: 'Sekolah saya adalah SMAN81.' dalam bahasa Jepang!",
        },
      ];

      let currentChallengeIndex = 0;
      let currentCorrectOrder = [];
      let currentScrambledWords = [];
      let currentInput = [];

      const taskPromptEl = document.getElementById("task-prompt");
      const wordBankEl = document.getElementById("word-bank");
      const inputAreaEl = document.getElementById("input-area");
      const nextButton = document.getElementById("next-button");
      const messageAreaEl = document.getElementById("message-area");
      const completionModalEl = document.getElementById("completion-modal");
      const currentIndexEl = document.getElementById("current-index");
      const totalChallengesEl = document.getElementById("total-challenges");

      // LLM elements
      const hintButton = document.getElementById("hint-button");
      const explanationButton = document.getElementById("explanation-button");
      const llmResponseArea = document.getElementById("llm-response");
      const llmContentEl = document.getElementById("llm-content");

      /**
       * Fisher-Yates (Knuth) Shuffle Algorithm
       * @param {Array} array
       */
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      /**
       * Initializes the game or moves to the next challenge.
       */
      function nextChallenge() {
        if (currentChallengeIndex >= challenges.length) {
          // Game over, show completion modal
          completionModalEl.classList.remove("hidden");
          return;
        }

        const challenge = challenges[currentChallengeIndex];

        // 1. Prepare Data
        currentCorrectOrder = challenge.jp.split(" ");

        // Create a temporary array of objects for scrambling while preserving original index
        const wordsForScramble = currentCorrectOrder.map((word, index) => ({
          word: word,
          originalIndex: index,
          elementId: `word-${index}-${currentChallengeIndex}`, // Unique ID for button
        }));

        currentScrambledWords = shuffleArray(wordsForScramble);
        currentInput = [];

        // 2. Update UI: Prompt
        taskPromptEl.textContent = challenge.id;

        // 3. Update UI: Word Bank
        wordBankEl.innerHTML = "";
        currentScrambledWords.forEach((item) => {
          const button = document.createElement("button");
          button.id = item.elementId;
          button.classList.add(
            "word-button",
            "bg-primary",
            "text-white",
            "font-semibold",
            "rounded-lg",
            "text-lg"
          ); // Removed px/py/uppercase for internal spans
          button.onclick = () =>
            selectWord(item.elementId, item.word, item.originalIndex);

          // Add Japanese text and Romaji text
          button.innerHTML = `
                    <span class="japanese-text">${romajiToJapanese(
                      item.word
                    )}</span>
                    <span class="romaji-text">${item.word}</span>
                `;
          wordBankEl.appendChild(button);
        });

        // 4. Reset Input Area, Messages, and LLM features
        resetInput(false);
        messageAreaEl.textContent = "";
        nextButton.disabled = true;
        nextButton.textContent = `Lanjut Tantangan (${currentChallengeIndex}/${challenges.length})`;
        currentIndexEl.textContent = currentChallengeIndex + 1;

        // LLM Reset
        hintButton.disabled = false;
        explanationButton.classList.add("hidden");
        llmResponseArea.classList.add("hidden");
        llmContentEl.innerHTML = "";
      }

      /**
       * Handles the selection of a word from the word bank.
       * @param {string} elementId - ID of the button element.
       * @param {string} word - The selected word.
       * @param {number} originalIndex - The original position of the word.
       */
      function selectWord(elementId, word, originalIndex) {
        const buttonEl = document.getElementById(elementId);

        // Ignore if already used or validation is complete
        if (
          buttonEl.classList.contains("used") ||
          nextButton.disabled === false
        ) {
          return;
        }

        // 1. Add word to user input
        currentInput.push({ word, originalIndex });

        // 2. Mark the button as used
        buttonEl.classList.add("used");
        buttonEl.classList.remove("bg-primary", "hover:bg-primary/80");

        // 3. Update Input Area
        renderInputArea();

        // 4. Check for completion
        if (currentInput.length === currentCorrectOrder.length) {
          checkAnswer();
        } else {
          // Clear any previous error messages or LLM response
          messageAreaEl.textContent = "";
          llmResponseArea.classList.add("hidden");
        }
      }

      /**
       * Renders the current words in the input area.
       */
      function renderInputArea() {
        inputAreaEl.innerHTML = "";
        if (currentInput.length === 0) {
          inputAreaEl.innerHTML =
            '<span class="text-gray-400 italic">Klik kata-kata di bawah untuk menyusun kalimat...</span>';
          return;
        }

        currentInput.forEach((item, index) => {
          const span = document.createElement("span");
          // Display both Japanese and Romaji in the input area as well for consistency
          span.innerHTML = `
                    <span class="japanese-text block">${
                      romajiToJapanese(item.word).split("/")[0]
                    }</span>
                    <span class="romaji-text block">${item.word}</span>
                `;
          span.classList.add(
            "bg-secondary/20",
            "text-gray-900",
            "font-medium",
            "px-3",
            "py-1",
            "rounded-md",
            "border",
            "border-secondary/50",
            "text-center",
            "inline-flex",
            "flex-col",
            "items-center",
            "justify-center"
          );

          // Add click listener to remove word (unselect)
          span.onclick = () => unselectWord(index);
          span.title = "Klik untuk menghapus";

          inputAreaEl.appendChild(span);
        });
      }

      /**
       * Handles the unselection of a word from the input area (sends it back to the bank).
       * @param {number} inputIndex - Index of the word in the currentInput array.
       */
      function unselectWord(inputIndex) {
        if (nextButton.disabled === false) return; // Cannot unselect after validation success

        const wordToUnselect = currentInput[inputIndex];

        // Find the original button element ID
        const item = currentScrambledWords.find(
          (w) =>
            w.originalIndex === wordToUnselect.originalIndex &&
            w.word === wordToUnselect.word
        );

        if (item) {
          const buttonEl = document.getElementById(item.elementId);
          // 1. Mark button as unused
          buttonEl.classList.remove("used");
          buttonEl.classList.add("bg-primary");
        }

        // 2. Remove from input array
        currentInput.splice(inputIndex, 1);

        // 3. Re-render input area
        renderInputArea();

        // 4. Clear message area and LLM response
        messageAreaEl.textContent = "";
        llmResponseArea.classList.add("hidden");
      }

      /**
       * Resets the current input and returns all words to the bank.
       * @param {boolean} showMessage - Whether to display a reset message. Default is true.
       */
      function resetInput(showMessage = true) {
        currentInput = [];
        // Remove 'used' class from all buttons
        document
          .querySelectorAll("#word-bank .word-button")
          .forEach((button) => {
            button.classList.remove("used");
            button.classList.add("bg-primary");
            button.onclick = () => {
              const item = currentScrambledWords.find(
                (w) => w.elementId === button.id
              );
              if (item)
                selectWord(item.elementId, item.word, item.originalIndex);
            };
          });
        renderInputArea();
        nextButton.disabled = true;
        messageAreaEl.textContent = showMessage ? "Susunan diulangi." : "";
        messageAreaEl.classList.remove("text-red-500", "text-secondary");

        // Re-enable all buttons in input area for reset
        inputAreaEl.querySelectorAll("span").forEach((span) => {
          span.onclick = null; // Prevent removing words that are about to be cleared
        });

        // LLM Reset
        llmResponseArea.classList.add("hidden");
        llmContentEl.innerHTML = "";
        explanationButton.classList.add("hidden");
      }

      /**
       * Checks the user's completed sentence against the correct sentence.
       */
      function checkAnswer() {
        const userAnswer = currentInput.map((item) => item.word).join(" ");
        const correctAnswer = currentCorrectOrder.join(" ");

        if (userAnswer === correctAnswer) {
          messageAreaEl.textContent = "BENAR! Kerja bagus!";
          messageAreaEl.classList.remove("text-red-500");
          messageAreaEl.classList.add("text-secondary");
          nextButton.disabled = false;

          // Show Explanation button
          explanationButton.classList.remove("hidden");

          // Final check before incrementing
          if (currentChallengeIndex < challenges.length - 1) {
            currentChallengeIndex++;
            nextButton.textContent = `Lanjut Tantangan (${currentChallengeIndex}/${challenges.length})`;
          } else {
            currentChallengeIndex++;
            nextButton.textContent = `Selesaikan Game`;
          }

          // Make input area static after success
          inputAreaEl
            .querySelectorAll("span")
            .forEach((span) => (span.onclick = null));
        } else {
          messageAreaEl.textContent = "SALAH. Coba lagi atau ulangi susunan.";
          messageAreaEl.classList.remove("text-secondary");
          messageAreaEl.classList.add("text-red-500");
          nextButton.disabled = true;
          explanationButton.classList.add("hidden");
        }
      }

      // --- LLM Feature Functions ---

      /**
       * Calls the LLM to provide a hint for the current challenge.
       */
      async function getHint() {
        hintButton.disabled = true;
        hintButton.classList.add("llm-loading");
        llmResponseArea.classList.remove("hidden");
        llmContentEl.innerHTML = "Memuat petunjuk dari Tutor Gemini...";

        const currentChallenge = challenges[currentChallengeIndex];
        const currentScrambled = currentScrambledWords
          .map((w) => w.word)
          .join(", ");

        const systemPrompt =
          "You are a helpful Japanese tutor. Your task is to provide a concise hint for the user to correctly reassemble a Japanese sentence. Do not give the direct answer or the full correct sentence. Provide the hint in Indonesian.";
        const userQuery = `The current scrambled sentence words are: ${currentScrambled}. The correct sentence means: ${currentChallenge.id}. Give me a hint on the correct word order, where the verb/predicate usually goes, or the meaning of a key particle (wa, ni, ga).`;

        const responseText = await fetchLlmResponse(userQuery, systemPrompt);

        llmContentEl.innerHTML = responseText.replace(/\n/g, "<br>"); // Format output
        hintButton.classList.remove("llm-loading");
        hintButton.disabled = false;
      }

      /**
       * Calls the LLM to explain the grammar of the solved sentence.
       */
      async function getExplanation() {
        explanationButton.disabled = true;
        explanationButton.classList.add("llm-loading");
        explanationButton.textContent = "Memuat Penjelasan...";
        llmResponseArea.classList.remove("hidden");
        llmContentEl.innerHTML =
          "Memuat penjelasan tata bahasa dari Tutor Gemini...";

        const currentChallenge = challenges[currentChallengeIndex - 1]; // Already incremented index
        const correctSentence = currentChallenge.jp;

        const systemPrompt =
          "You are a Japanese grammar expert. Provide a detailed but easy-to-understand explanation of the following Japanese sentence. Focus on the grammar patterns, particle usage, and translation. The explanation must be structured, using bold for key terms (like 'Pola Kalimat' or 'Partikel'). The explanation must be in Indonesian.";
        const userQuery = `Explain the grammar and meaning of the sentence: ${correctSentence}.`;

        const responseText = await fetchLlmResponse(userQuery, systemPrompt);

        llmContentEl.innerHTML = responseText.replace(/\n/g, "<br>"); // Format output
        explanationButton.classList.remove("llm-loading");
        explanationButton.disabled = false;
        explanationButton.textContent = "✨ Jelaskan Tata Bahasa Kalimat Ini";
      }

      // Initialize the game when the window loads
      window.onload = function () {
        totalChallengesEl.textContent = challenges.length;
        nextChallenge();
      };
    </script>
  </body>
</html>
